<script>
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const map = L.map('map', { attributionControl: false, zoomControl: false, tap: false }).setView([48.3, 37.5], 7);
    darkTiles.addTo(map);

    let mainGeoLayer, layers = { main: L.layerGroup().addTo(map) };
    const pulsingIcon = L.divIcon({ className: 'dot-container', html: '<div class="pulsating-dot"></div>', iconSize: [12, 12], iconAnchor: [6, 6] });

    async function loadData() {
        const jsonPath = 'data/map.json'; // Путь к твоему файлу
        try {
            const res = await fetch(jsonPath + '?v=' + Date.now());
            
            if (!res.ok) {
                throw new Error(`Файл не найден по адресу: ${jsonPath}`);
            }

            const data = await res.json();
            console.log("Данные загружены:", data);

            mainGeoLayer = L.geoJSON(data, {
                style: (f) => ({ 
                    fillColor: f.properties.color || "#8b0000", 
                    color: f.properties.color || "#8b0000",
                    weight: 2,
                    fillOpacity: 0.4
                }),
                pointToLayer: (f, latlng) => L.marker(latlng, { icon: pulsingIcon }),
                onEachFeature: (f, layer) => {
                    if (f.properties && f.properties.name) {
                        layer.bindTooltip(f.properties.name);
                    }
                }
            }).addTo(layers.main);

            // Автоматически подстроить камеру под полигоны
            if (mainGeoLayer.getBounds().isValid()) {
                map.fitBounds(mainGeoLayer.getBounds());
            }

        } catch(e) { 
            console.error(e);
            alert("ОШИБКА JSON: " + e.message + "\nПроверь, что папка 'data' лежит в корне рядом с index.html"); 
        }
    }

    loadData();
    
    // Остальной код (рисовалка, табы) остается прежним...
</script>
