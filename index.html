<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PolitMap | Tactical Command</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --army-red: #8b0000; --khaki: #c2b280; --sidebar: #0d0d0d; --border: #222; }
        body { margin: 0; background: #000; font-family: "Segoe UI", sans-serif; display: flex; color: #777; overflow: hidden; }
        
        /* ТАБ-БАР */
        #tab-bar { width: 50px; height: 100vh; background: #111; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 3001; }
        .tab-btn { width: 35px; height: 35px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; border-radius: 4px; transition: 0.2s; }
        .tab-btn.active { color: var(--khaki); background: #3b4634; }
        
        /* САЙДБАР */
        #sidebar { width: 280px; height: 100vh; background: var(--sidebar); border-right: 1px solid var(--border); z-index: 3000; transition: 0.3s; position: relative; overflow-y: auto; }
        #sidebar.collapsed { margin-left: -280px; }
        
        .tab-page { display: none; padding: 20px; }
        .tab-page.active { display: block; }
        .header-title { font-size: 14px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 20px; color: #fff; }

        /* SWITCHES */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #222; transition: .3s; border-radius: 18px; border: 1px solid #333; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: #555; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b4634; border-color: var(--khaki); }
        input:checked + .slider:before { transform: translateX(16px); background-color: var(--khaki); }

        #map-container { position: relative; flex-grow: 1; height: 100vh; }
        #map { height: 100%; width: 100%; background: #0a0a0a !important; }
        #paint-canvas { position: absolute; top: 0; left: 0; z-index: 1000; pointer-events: none; }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        .tool-btn { width: 100%; padding: 10px; background: #151515; border: 1px solid #222; color: #777; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; font-size: 12px; transition: 0.2s; }
        .tool-btn svg { width: 16px; height: 16px; stroke: currentColor; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }
        
        .control-group { margin-bottom: 15px; padding: 10px; background: #111; border-radius: 4px; }
        .control-label { display: block; font-size: 11px; margin-bottom: 8px; color: #555; text-transform: uppercase; }
        .item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 13px; color: #ccc; }
        
        .info-text { font-size: 13px; line-height: 1.6; color: #888; }
        .info-text b { color: var(--khaki); }

        input[type="color"] { width: 100%; height: 25px; border: none; background: none; cursor: pointer; }
        input[type="range"] { width: 100%; accent-color: var(--khaki); }

        .dot-container { background: transparent !important; border: none !important; }
        .pulsating-dot { width: 10px; height: 10px; background-color: #ff3b3b; border-radius: 50%; box-shadow: 0 0 10px #ff3b3b; position: relative; }
        .pulsating-dot::after { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; border: 2px solid #ff3b3b; border-radius: 50%; animation: pulse-wave 1.5s ease-out infinite; }
        @keyframes pulse-wave { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
    </style>
</head>
<body>

<div id="tab-bar">
    <div id="btn-layers" class="tab-btn active" onclick="handleTab('layers')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
    <div id="btn-draw" class="tab-btn" onclick="handleTab('draw')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3zM18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path></svg></div>
    <div id="btn-info" class="tab-btn" onclick="handleTab('info')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>
</div>

<div id="sidebar">
    <div id="layers" class="tab-page active">
        <div class="header-title">Карта</div>
        <div class="item"><span>Спутниковая карта</span><label class="switch"><input type="checkbox" id="satToggle" onchange="toggleSatellite()"><span class="slider"></span></label></div>
        <div class="item"><span>Слои данных</span><label class="switch"><input type="checkbox" checked id="layerToggle" onchange="toggleLayer('main')"><span class="slider"></span></label></div>
        <div class="item"><span>Границы (JSON)</span><label class="switch"><input type="checkbox" checked id="borderToggle" onchange="updateStyles()"><span class="slider"></span></label></div>
    </div>

    <div id="draw" class="tab-page">
        <div class="header-title">Тактическая рисовалка</div>
        <div class="control-group">
            <button class="tool-btn active" onclick="setTool('brush', this)"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg> Кисть</button>
            <button class="tool-btn" onclick="setTool('rect', this)"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> Квадрат</button>
            <button class="tool-btn" onclick="setTool('circle', this)"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg> Круг</button>
            <button class="tool-btn" onclick="setTool('arrow', this)"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"></path></svg> Стрелка</button>
        </div>
        <div class="control-group">
            <span class="control-label">Цвет</span>
            <input type="color" id="paint-color" value="#c2b280">
        </div>
        <div class="control-group">
            <span class="control-label">Размер: <span id="size-val">3</span>px</span>
            <input type="range" id="paint-size" min="1" max="20" value="3" oninput="document.getElementById('size-val').innerText=this.value">
        </div>
        <button class="tool-btn" onclick="togglePaintMode()" id="toggle-paint-btn" style="justify-content: center;">ВКЛЮЧИТЬ РИСОВАНИЕ</button>
        <button class="tool-btn" onclick="clearCanvas()" style="color:#ff4444; margin-top: 10px; justify-content: center;">Очистить рисунки</button>
    </div>

    <div id="info" class="tab-page">
        <div class="header-title">Информация</div>
        <div class="info-text">
            <p><b>PolitMap v1.1</b></p>
            <p>Гибридный тактический терминал. Спутниковые снимки усилены слоем мировых границ Esri.</p>
            <p>Для корректной работы убедитесь, что файл <b>map.json</b> лежит в папке <b>data</b> на вашем GitHub.</p>
        </div>
    </div>
</div>

<div id="map-container">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ИНИЦИАЛИЗАЦИЯ СЛОЕВ КАРТЫ
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const satTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const satLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');

    const map = L.map('map', { attributionControl: false, zoomControl: false }).setView([48.3, 37.5], 7);
    darkTiles.addTo(map);

    let mainGeoLayer;
    let layers = { main: L.layerGroup().addTo(map) };
    const canvas = document.getElementById('paint-canvas');
    const ctx = canvas.getContext('2d');
    
    let isPaintingMode = false, isDrawing = false, tool = 'brush', startX, startY, snapshot;

    // ПЕРЕКЛЮЧЕНИЕ СПУТНИКА С ГРАНИЦАМИ
    function toggleSatellite() {
        if (document.getElementById('satToggle').checked) {
            map.removeLayer(darkTiles);
            satTiles.addTo(map);
            satLabels.addTo(map);
        } else {
            map.removeLayer(satTiles);
            map.removeLayer(satLabels);
            darkTiles.addTo(map);
        }
    }

    function resizeCanvas() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function getStyle(feature) {
        const showBorder = document.getElementById('borderToggle').checked;
        const c = (feature.properties && feature.properties.color) ? feature.properties.color : "#8b0000";
        return {
            fillColor: c, color: c,
            weight: showBorder ? 2 : 0,
            fillOpacity: (feature.properties && feature.properties.fillOpacity) || 0.4,
            opacity: showBorder ? 1 : 0
        };
    }

    const pulsingIcon = L.divIcon({ className: 'dot-container', html: '<div class="pulsating-dot"></div>', iconSize: [10, 10], iconAnchor: [5, 5] });

    async function loadData() {
        try {
            const res = await fetch('data/map.json?v=' + Date.now());
            if (!res.ok) throw new Error('Not found');
            const data = await res.json();
            layers.main.clearLayers();
            mainGeoLayer = L.geoJSON(data, {
                style: getStyle,
                pointToLayer: (f, l) => L.marker(l, { icon: pulsingIcon }),
                onEachFeature: (f, layer) => {
                    if (f.geometry.type === 'Point' && f.properties.name) {
                        layer.on('click', (e) => {
                            if (layer.getTooltip()) { layer.closeTooltip(); layer.unbindTooltip(); }
                            else { layer.bindTooltip(f.properties.name, { permanent: true, direction: 'top', offset: [0, -10] }).openTooltip(); }
                            L.DomEvent.stopPropagation(e);
                        });
                    }
                }
            }).addTo(layers.main);
        } catch(e) { console.error("Ошибка загрузки JSON. Проверьте путь data/map.json"); }
    }

    function togglePaintMode() {
        isPaintingMode = !isPaintingMode;
        const btn = document.getElementById('toggle-paint-btn');
        if (isPaintingMode) {
            btn.innerText = "ВЫКЛЮЧИТЬ РИСОВАНИЕ"; btn.classList.add('active');
            canvas.classList.add('active'); map.dragging.disable();
        } else {
            btn.innerText = "ВКЛЮЧИТЬ РИСОВАНИЕ"; btn.classList.remove('active');
            canvas.classList.remove('active'); map.dragging.enable();
        }
    }

    function setTool(t, btn) {
        tool = t;
        document.querySelectorAll('#draw .tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // ЛОГИКА РИСОВАНИЯ (CANVAS)
    canvas.addEventListener('mousedown', (e) => {
        if (!isPaintingMode) return;
        isDrawing = true; startX = e.offsetX; startY = e.offsetY;
        ctx.strokeStyle = document.getElementById('paint-color').value;
        ctx.lineWidth = document.getElementById('paint-size').value;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        if (tool !== 'brush') ctx.putImageData(snapshot, 0, 0);
        if (tool === 'brush') { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
        else if (tool === 'rect') { ctx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY); }
        else if (tool === 'circle') {
            ctx.beginPath();
            let radius = Math.sqrt(Math.pow(startX - e.offsetX, 2) + Math.pow(startY - e.offsetY, 2));
            ctx.arc(startX, startY, radius, 0, 2 * Math.PI); ctx.stroke();
        } else if (tool === 'arrow') { drawArrow(startX, startY, e.offsetX, e.offsetY); }
    });

    canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });

    function drawArrow(x1, y1, x2, y2) {
        const headlen = 15; const angle = Math.atan2(y2 - y1, x2 - x1);
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
        ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(x2, y2); ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
        ctx.stroke();
    }

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function handleTab(id) {
        const sb = document.getElementById('sidebar'), btn = document.getElementById('btn-' + id);
        if (btn.classList.contains('active')) { sb.classList.toggle('collapsed'); }
        else {
            sb.classList.remove('collapsed');
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active'); btn.classList.add('active');
        }
        setTimeout(() => { map.invalidateSize(); resizeCanvas(); }, 300);
    }

    function updateStyles() { if (mainGeoLayer) mainGeoLayer.setStyle(getStyle); }
    function toggleLayer(k) { 
        const isChecked = document.getElementById('layerToggle').checked;
        if (isChecked) map.addLayer(layers[k]); else map.removeLayer(layers[k]);
    }

    loadData();
</script>
</body>
</html>