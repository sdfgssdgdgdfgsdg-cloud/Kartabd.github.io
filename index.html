<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --army-red: #8b0000; --khaki: #c2b280; --sidebar: #0d0d0d; --border: #222; }
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }
        
        /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ –ò–ö–û–ù–û–ö */
        #tab-bar { width: 60px; min-width: 60px; background: #111; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 3001; }
        .tab-btn { width: 44px; height: 44px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; transition: 0.2s; border: 1px solid transparent; }
        .tab-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
        .tab-btn.active { color: var(--khaki); background: #1a1e16; border-color: #3b4634; }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { width: 280px; min-width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); z-index: 3000; display: flex; flex-direction: column; }
        
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 60px; width: calc(100vw - 60px); height: 100%; transform: translateX(-120%); transition: 0.3s; }
            #sidebar.mobile-open { transform: translateX(0); }
        }

        .tab-page { display: none; padding: 25px 20px; height: 100%; overflow-y: auto; }
        .tab-page.active { display: block; }
        .tab-page h3 { color: #fff; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 20px 0; border-bottom: 1px solid #222; padding-bottom: 10px; }
        
        /* –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .tool-btn { width: 100%; padding: 12px; background: #151515; border: 1px solid #333; color: #888; margin-bottom: 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px; font-size: 13px; transition: 0.2s; text-align: left; }
        .tool-btn:hover { background: #1a1a1a; color: #fff; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }

        /* –ö–ê–†–¢–ê */
        #map-container { position: relative; flex-grow: 1; height: 100vh; background: #000; }
        #map { height: 100%; width: 100%; }
        #paint-canvas { position: absolute; top: 0; left: 0; z-index: 1000; pointer-events: none; width: 100%; height: 100%; touch-action: none; }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* –ü–û–õ–ò–ì–û–ù–´ */
        .pulsating-dot { width: 12px; height: 12px; background: #ff3b3b; border-radius: 50%; box-shadow: 0 0 10px #ff3b3b; }
        
        /* –ö–ê–†–¢–û–ß–ö–ê –†–ï–ö–í–ò–ó–ò–¢–û–í */
        .donate-card { background: #0a0a0a; border: 1px solid #222; padding: 20px; border-radius: 10px; text-align: center; margin-top: 10px; }
        .card-num { font-family: monospace; color: var(--khaki); font-size: 18px; display: block; margin: 15px 0; letter-spacing: 1px; border: 1px dashed #333; padding: 10px; }
    </style>
</head>
<body>

<div id="tab-bar">
    <div id="btn-layers" class="tab-btn active" onclick="showTab('layers')" title="–ö–∞—Ä—Ç–∞">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
    </div>
    <div id="btn-draw" class="tab-btn" onclick="showTab('draw')" title="–†–∏—Å–æ–≤–∞–Ω–∏–µ">
        <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
    </div>
    <div id="btn-donate" class="tab-btn" onclick="showTab('donate')" title="–†–µ–∫–≤–∏–∑–∏—Ç—ã">
        <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
    </div>
</div>

<div id="sidebar">
    <div id="page-layers" class="tab-page active">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <button class="tool-btn" id="sat-btn" onclick="toggleSat()">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–ª–æ–π</button>
        <button class="tool-btn" onclick="loadMapData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω—ã</button>
    </div>

    <div id="page-draw" class="tab-page">
        <h3>–†–∏—Å–æ–≤–∞–Ω–∏–µ</h3>
        <button class="tool-btn active" id="tool-brush" onclick="setTool('brush')">üñåÔ∏è –ö–∏—Å—Ç—å</button>
        <button class="tool-btn" id="tool-arrow" onclick="setTool('arrow')">‚ÜóÔ∏è –°—Ç—Ä–µ–ª–∫–∞</button>
        <div style="margin: 15px 0;">
            <label style="font-size: 11px; color: #555; display: block; margin-bottom: 5px;">–¶–í–ï–¢</label>
            <input type="color" id="paint-color" value="#c2b280" style="width:100%; height:35px; border:1px solid #333; background:none; cursor:pointer;">
        </div>
        <button class="tool-btn" id="paint-toggle-btn" onclick="togglePaint()" style="background: #222; color: #fff; justify-content: center;">–í–ö–õ–Æ–ß–ò–¢–¨ –†–ï–ñ–ò–ú</button>
        <button class="tool-btn" onclick="clearCanvas()" style="color: #ff4444; justify-content: center; margin-top: 10px; border-color: #400;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div id="page-donate" class="tab-page">
        <h3>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
        <p style="font-size: 13px; color: #888; line-height: 1.4;">–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç:</p>
        <div class="donate-card">
            <span style="font-size: 10px; color: #444;">HOMEP –ö–ê–†–¢–´</span>
            <span class="card-num" id="card-value">0000 0000 0000 0000</span>
            <button class="tool-btn" onclick="copyCard()" style="justify-content: center; background: #1a1e16; color: #fff;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="map-container">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.3, 37.5], 7);
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    let isSat = false;
    function toggleSat() {
        isSat = !isSat;
        if(isSat) { map.removeLayer(darkLayer); satLayer.addTo(map); }
        else { map.removeLayer(satLayer); darkLayer.addTo(map); }
        document.getElementById('sat-btn').classList.toggle('active', isSat);
    }

    // –õ–û–ì–ò–ö–ê –¢–ê–ë–û–í
    function showTab(tabId) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ
        document.getElementById('btn-' + tabId).classList.add('active');
        document.getElementById('page-' + tabId).classList.add('active');
        
        // –î–ª—è –º–æ–±–∏–ª–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('mobile-open');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        setTimeout(() => map.invalidateSize(), 200);
    }

    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    let geoLayer;
    const pIcon = L.divIcon({ className: 'p-container', html: '<div class="pulsating-dot"></div>', iconSize:[12,12], iconAnchor:[6,6] });

    async function loadMapData() {
        try {
            const r = await fetch('data/map.json?v=' + Date.now());
            if(!r.ok) return;
            const data = await r.json();
            if(geoLayer) map.removeLayer(geoLayer);

            geoLayer = L.geoJSON(data, {
                style: (f) => ({ fillColor: f.properties.color || "#8b0000", color: f.properties.color || "#8b0000", weight: 2, fillOpacity: 0.4 }),
                pointToLayer: (f, ll) => L.marker(ll, { icon: pIcon }),
                onEachFeature: (f, l) => {
                    if(f.properties.name) l.bindTooltip(f.properties.name, { sticky: true });
                }
            }).addTo(map);

            const bounds = geoLayer.getBounds();
            if(bounds.isValid()) map.fitBounds(bounds);
        } catch(e) { console.error("–û—à–∏–±–∫–∞ JSON"); }
    }

    // –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ö–ê–†–¢–´
    function copyCard() {
        const val = document.getElementById('card-value').innerText;
        navigator.clipboard.writeText(val);
        alert("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    }

    // –†–ò–°–û–í–ê–õ–ö–ê
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let isPainting = false, isDrawing = false, currentTool = 'brush', snapshot, startX, startY;

    function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function togglePaint() {
        isPainting = !isPainting;
        const btn = document.getElementById('paint-toggle-btn');
        btn.innerText = isPainting ? "–í–´–ö–õ–Æ–ß–ò–¢–¨" : "–í–ö–õ–Æ–ß–ò–¢–¨ –†–ï–ñ–ò–ú";
        btn.style.background = isPainting ? "#8b0000" : "#222";
        canvas.classList.toggle('active', isPainting);
        isPainting ? map.dragging.disable() : map.dragging.enable();
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('#page-draw .tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + t).classList.add('active');
    }

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: x - rect.left, y: y - rect.top };
    }

    canvas.addEventListener('mousedown', (e) => {
        if(!isPainting) return;
        isDrawing = true;
        const pos = getMousePos(e);
        startX = pos.x; startY = pos.y;
        ctx.strokeStyle = document.getElementById('paint-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if(currentTool === 'brush') { ctx.beginPath(); ctx.moveTo(startX, startY); }
    });

    window.addEventListener('mousemove', (e) => {
        if(!isDrawing || !isPainting) return;
        const pos = getMousePos(e);
        if(currentTool === 'brush') {
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
        } else {
            ctx.putImageData(snapshot, 0, 0);
            drawArrow(startX, startY, pos.x, pos.y);
        }
    });

    function drawArrow(x1, y1, x2, y2) {
        const head = 15, angle = Math.atan2(y2-y1, x2-x1);
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
        ctx.lineTo(x2-head*Math.cos(angle-Math.PI/6), y2-head*Math.sin(angle-Math.PI/6));
        ctx.moveTo(x2, y2); ctx.lineTo(x2-head*Math.cos(angle+Math.PI/6), y2-head*Math.sin(angle+Math.PI/6));
        ctx.stroke();
    }

    window.addEventListener('mouseup', () => isDrawing = false);
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    // –°–¢–ê–†–¢
    loadMapData();
</script>
</body>
</html>
