<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap | Tactical Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --army-red: #8b0000;
            --khaki: #c2b280;
            --sidebar-bg: #0d0d0d;
            --border-color: #222;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #tab-bar { width: 60px; min-width: 60px; background: #111; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10001; }
        #sidebar { 
            width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); 
            z-index: 10000; display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }
        #sidebar.collapsed { width: 0; min-width: 0; border-right: none; transform: translateX(-10px); opacity: 0; pointer-events: none; }

        .tab-btn { width: 44px; height: 44px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; }
        .tab-btn.active { color: var(--khaki); background: #1a1e16; border: 1px solid #3b4634; }
        .tab-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }

        .tab-page { display: none; padding: 25px 20px; height: 100%; overflow-y: auto; min-width: 300px; }
        .tab-page.active { display: block; }

        /* –ö–ù–û–ü–ö–ò –ò –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–ò */
        .switch-group { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 12px; padding: 14px; background: #151515; border-radius: 8px;
            border: 1px solid #222;
        }
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 22px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--army-red); }
        input:checked + .slider:before { transform: translateX(22px); }

        .tool-btn { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; margin-top: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* –ö–ê–†–¢–ê */
        #map-wrap { position: relative; flex-grow: 1; height: 100vh; z-index: 1; }
        #map { height: 100%; width: 100%; z-index: 10; background: #000; }
        
        /* –°—Ç–∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤ */
        .pulsating-dot { width: 12px; height: 12px; background: #ff3b3b; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 10px rgba(255,0,0,0.5); }
        .custom-tooltip { background: #000 !important; border: 1px solid var(--khaki) !important; color: #fff !important; font-weight: bold; }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="btn-map" onclick="toggleTab('map')">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
    </div>
    <div class="tab-btn" id="btn-don" onclick="toggleTab('don')">
        <svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M6 12h.01M18 12h.01"/></svg>
    </div>
</div>

<div id="sidebar">
    <div id="t-map" class="tab-page active">
        <h2 style="font-size: 14px; color: #fff; margin-bottom: 20px;">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–†–¢–û–ô</h2>
        
        <div class="switch-group">
            <span>–°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–ª–æ–π</span>
            <label class="switch">
                <input type="checkbox" id="sat-switch" onchange="toggleLayers()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="switch-group">
            <span>–ì—Ä–∞–Ω–∏—Ü–∞</span>
            <label class="switch">
                <input type="checkbox" id="border-switch" checked onchange="updateGeoVisibility()">
                <span class="slider"></span>
            </label>
        </div>

        <button class="tool-btn" onclick="loadMapData()">
            <span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ JSON
        </button>
        
        <p style="font-size: 12px; color: #555; margin-top: 20px; line-height: 1.5;">
            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫—ç—à —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </p>
    </div>

    <div id="t-don" class="tab-page">
        <h2>–ü–û–î–î–ï–†–ñ–ö–ê</h2>
        </div>
</div>

<div id="map-wrap">
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.3, 37.5], 7);
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const osmLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–æ–∏—Ç —Ç–µ–º–Ω–∞—è –∫–∞—Ä—Ç–∞
    darkTiles.addTo(map);

    // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    function toggleLayers() {
        const isSat = document.getElementById('sat-switch').checked;
        if(isSat) {
            if(map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
            esriSatellite.addTo(map);
            osmLabels.addTo(map);
        } else {
            if(map.hasLayer(esriSatellite)) map.removeLayer(esriSatellite);
            if(map.hasLayer(osmLabels)) map.removeLayer(osmLabels);
            darkTiles.addTo(map);
        }
    }

    // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ JSON –æ–±—ä–µ–∫—Ç–æ–≤
    let geoJsonData = null; // –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ —Ç—É—Ç
    let geoJsonLayer = null; // –•—Ä–∞–Ω–∏–º —Å–ª–æ–π —Ç—É—Ç

    async function loadMapData() {
        try {
            // –ü—Ä–∏–º–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –ø—É—Ç—å)
            // const r = await fetch('data/map.json?v=' + Date.now());
            // geoJsonData = await r.json();
            
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
            geoJsonData = { "type": "FeatureCollection", "features": [] }; 
            
            renderGeoJson();
        } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON"); }
    }

    function renderGeoJson() {
        if(geoJsonLayer) map.removeLayer(geoJsonLayer);
        
        geoJsonLayer = L.geoJSON(geoJsonData, {
            style: (f) => ({
                fillColor: f.properties.color || "#8b0000",
                fillOpacity: 0.4,
                color: f.properties.color || "#8b0000",
                weight: 2
            }),
            pointToLayer: (f, ll) => L.marker(ll, { 
                icon: L.divIcon({ className: '', html: '<div class="pulsating-dot"></div>', iconSize: [12,12], iconAnchor: [6,6] }) 
            }),
            onEachFeature: (f, l) => {
                l.bindTooltip(f.properties.name || "–û–±—ä–µ–∫—Ç", { className: 'custom-tooltip', direction: 'top' });
            }
        });

        if(document.getElementById('border-switch').checked) {
            geoJsonLayer.addTo(map);
        }
    }

    function updateGeoVisibility() {
        if(!geoJsonLayer) return;
        const isVisible = document.getElementById('border-switch').checked;
        if(isVisible) {
            geoJsonLayer.addTo(map);
        } else {
            map.removeLayer(geoJsonLayer);
        }
    }

    // –õ–æ–≥–∏–∫–∞ –≤–∫–ª–∞–¥–æ–∫
    let currentActiveTab = 'map';
    function toggleTab(id) {
        const sidebar = document.getElementById('sidebar');
        if (currentActiveTab === id && !sidebar.classList.contains('collapsed')) {
            sidebar.classList.add('collapsed');
        } else {
            sidebar.classList.remove('collapsed');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
            document.getElementById('t-' + id).classList.add('active');
            currentActiveTab = id;
        }
        setTimeout(() => map.invalidateSize(), 300);
    }

    loadMapData();
</script>
</body>
</html>
