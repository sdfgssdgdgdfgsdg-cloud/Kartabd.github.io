<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap Terminal</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --army-red: #8b0000;
            --khaki: #c2b280;
            --sidebar-bg: #0d0d0d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background: #000; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #tab-bar { width: 60px; min-width: 60px; background: #111; border-right: 1px solid #222; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10005; }
        #sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid #222; z-index: 10004; transition: 0.3s ease; position: relative; }
        #sidebar.collapsed { width: 0; opacity: 0; pointer-events: none; }

        .tab-btn { width: 44px; height: 44px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; }
        .tab-btn.active { color: var(--khaki); background: #1a1e16; border: 1px solid #3b4634; }
        .tab-btn svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; }

        .tab-page { display: none; padding: 25px 20px; }
        .tab-page.active { display: block; }

        /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .switch-group { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #151515; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 1px solid #222; }
        .tool-btn { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #888; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 10px; text-transform: uppercase; font-size: 11px; }
        .main-action { background: var(--army-red) !important; color: #fff !important; border: none !important; }

        /* –ö–ê–†–¢–ê –ò –•–û–õ–°–¢ */
        #map-container { position: relative; flex-grow: 1; height: 100%; z-index: 1; background: #050505; }
        #map { height: 100%; width: 100%; z-index: 10; }
        #paint-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; pointer-events: none; }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* –ü–£–õ–¨–°–ò–†–£–Æ–©–ê–Ø –¢–û–ß–ö–ê (–ò–î–ï–ê–õ–¨–ù–´–ô –¶–ï–ù–¢–†) */
        .dot-container { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
        .pulsating-dot { 
            width: 8px; height: 8px; background: #ff4444; 
            border-radius: 50%; position: relative;
            box-shadow: 0 0 10px #ff4444; 
        }
        .pulsating-dot::after {
            content: ''; position: absolute; 
            top: 50%; left: 50%;
            width: 8px; height: 8px;
            margin: -4px 0 0 -4px; /* –°–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ –≤ —Ü–µ–Ω—Ç—Ä */
            border-radius: 50%; 
            border: 2px solid #ff4444; 
            animation: pulsate 1.8s ease-out infinite; 
            box-sizing: border-box;
        }
        @keyframes pulsate {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(5); opacity: 0; }
        }

        .custom-tooltip { background: #000 !important; border: 1px solid var(--khaki) !important; color: #fff !important; font-size: 11px; padding: 4px 8px; border-radius: 0; }

        /* –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ */
        .switch { position: relative; width: 40px; height: 20px; }
        .switch input { display: none; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 20px; transition: 0.4s; }
        .slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--army-red); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="btn-map" onclick="toggleTab('map')">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
    </div>
    <div class="tab-btn" id="btn-draw" onclick="toggleTab('draw')">
        <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
    </div>
</div>

<div id="sidebar">
    <div id="t-map" class="tab-page active">
        <h2 style="font-size: 11px; letter-spacing: 2px; margin-bottom: 20px; color: #555;">–¢–ï–†–ú–ò–ù–ê–õ</h2>
        <div class="switch-group" onclick="document.getElementById('sat-input').click()">
            <span>–°–ø—É—Ç–Ω–∏–∫</span>
            <label class="switch">
                <input type="checkbox" id="sat-input" onchange="toggleLayers()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-group" onclick="document.getElementById('obj-input').click()">
            <span>–§—Ä–æ–Ω—Ç –∏ –æ–±—ä–µ–∫—Ç—ã</span>
            <label class="switch">
                <input type="checkbox" id="obj-input" checked onchange="updateGeo()">
                <span class="slider"></span>
            </label>
        </div>
        <button class="tool-btn" onclick="loadMap()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <div id="t-draw" class="tab-page">
        <h2 style="font-size: 11px; letter-spacing: 2px; margin-bottom: 20px; color: #555;">–¢–ê–ö–¢–ò–ö–ê</h2>
        <button class="tool-btn main-action" id="draw-btn" onclick="togglePaint()">–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è</button>
        <button class="tool-btn" onclick="clearCanvas()">‚ùå –°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë</button>
        <p style="font-size: 10px; margin-top: 15px; color: #444;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—ã—à—å –∏–ª–∏ –ø–∞–ª–µ—Ü –¥–ª—è –Ω–∞–Ω–µ—Å–µ–Ω–∏—è –ø–æ–º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—É.</p>
    </div>
</div>

<div id="map-container">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- 1. –ù–ê–°–¢–†–û–ô–ö–ê –ö–ê–†–¢–´ ---
    const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');

    const map = L.map('map', { 
        zoomControl: false, 
        attributionControl: false, 
        layers: [dark] 
    }).setView([48.3, 37.5], 7);

    function toggleLayers() {
        if(document.getElementById('sat-input').checked) {
            map.removeLayer(dark); map.addLayer(esri); map.addLayer(labels);
        } else {
            map.removeLayer(esri); map.removeLayer(labels); map.addLayer(dark);
        }
    }

    // --- 2. –ó–ê–ì–†–£–ó–ö–ê –û–ë–™–ï–ö–¢–û–í (–¢–û–ß–ö–ò + –§–†–û–ù–¢) ---
    let geoLayer = null;

    async function loadMap() {
        try {
            const res = await fetch('data/map.json?v=' + Date.now());
            if (!res.ok) throw new Error();
            const data = await res.json();
            
            if(geoLayer) map.removeLayer(geoLayer);
            
            geoLayer = L.geoJSON(data, {
                // –°–¢–ò–õ–¨ –î–õ–Ø –§–†–û–ù–¢–ê (–õ–∏–Ω–∏–∏ –∏ –ø–æ–ª–∏–≥–æ–Ω—ã)
                style: (f) => ({
                    color: f.properties.color || "#8b0000",
                    weight: 3,
                    fillOpacity: 0.2,
                    interactive: false // –ü–æ–ª–∏–≥–æ–Ω—ã –Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç—ã—Ö –æ–∫–æ–Ω
                }),
                // –°–¢–ò–õ–¨ –î–õ–Ø –¢–û–ß–ï–ö
                pointToLayer: (f, ll) => {
                    const m = L.marker(ll, { 
                        icon: L.divIcon({ 
                            className: '', 
                            html: '<div class="dot-container"><div class="pulsating-dot"></div></div>', 
                            iconSize: [24,24], iconAnchor: [12,12] 
                        }) 
                    });

                    // –õ–ï–ô–ë–õ –¢–û–õ–¨–ö–û –ü–û –ö–õ–ò–ö–£ –ù–ê –¢–û–ß–ö–£
                    m.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        if (m.getTooltip()) {
                            m.unbindTooltip();
                        } else {
                            m.bindTooltip(f.properties.name || "–û–±—ä–µ–∫—Ç", { 
                                className: 'custom-tooltip', 
                                direction: 'top', 
                                offset: [0, -10] 
                            }).openTooltip();
                        }
                    });
                    return m;
                }
            });
            updateGeo();
        } catch(e) { console.warn("–§–∞–π–ª data/map.json –Ω–µ –Ω–∞–π–¥–µ–Ω"); }
    }

    function updateGeo() {
        if(!geoLayer) return;
        document.getElementById('obj-input').checked ? map.addLayer(geoLayer) : map.removeLayer(geoLayer);
    }

    // --- 3. –ò–ù–¢–ï–†–§–ï–ô–° –¢–ê–ë–û–í ---
    function toggleTab(id) {
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('btn-' + id).classList.add('active');
        document.getElementById('t-' + id).classList.add('active');
        document.getElementById('sidebar').classList.remove('collapsed');
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–∞–π–¥–±–∞—Ä–∞
        setTimeout(() => map.invalidateSize(), 300);
    }

    // --- 4. –¢–ê–ö–¢–ò–ß–ï–°–ö–û–ï –†–ò–°–û–í–ê–ù–ò–ï ---
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');

    function resize() { 
        canvas.width = canvas.offsetWidth; 
        canvas.height = canvas.offsetHeight; 
    }
    window.addEventListener('resize', resize);
    resize();

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function togglePaint() {
        const active = canvas.classList.toggle('active');
        document.getElementById('draw-btn').innerText = active ? "–í–´–ö–õ–Æ–ß–ò–¢–¨" : "–†–ï–ñ–ò–ú –†–ò–°–û–í–ê–ù–ò–Ø";
        
        if(active) {
            map.dragging.disable();
            map.touchZoom.disable();
            map.scrollWheelZoom.disable();
        } else {
            map.dragging.enable();
            map.touchZoom.enable();
            map.scrollWheelZoom.enable();
        }
    }

    let drawing = false;
    canvas.addEventListener('pointerdown', (e) => { 
        if(!canvas.classList.contains('active')) return;
        drawing = true; 
        ctx.beginPath(); 
        ctx.moveTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = "#c2b280"; 
        ctx.lineWidth = 3; 
        ctx.lineCap = 'round';
    });
    
    canvas.addEventListener('pointermove', (e) => { 
        if(drawing) { 
            ctx.lineTo(e.offsetX, e.offsetY); 
            ctx.stroke(); 
        } 
    });
    
    canvas.addEventListener('pointerup', () => drawing = false);

    // –ó–∞–ø—É—Å–∫
    loadMap();
</script>

</body>
</html>
