<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #000; color: #ccc; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 250px; background: #111; border-right: 1px solid #222; padding: 15px; z-index: 2000; overflow-y: auto; }
        #map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; }
        #paint-canvas { position: absolute; top: 0; left: 0; z-index: 1000; pointer-events: none; width: 100%; height: 100%; touch-action: none; }
        #paint-canvas.active { pointer-events: auto; }
        .btn { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; cursor: pointer; border-radius: 4px; font-size: 13px; }
        .btn:active { background: #333; }
        .btn.red { background: #400; border-color: #800; }
        .btn.active { background: #8b0000; }
        .dot-container { background: transparent !important; border: none !important; }
        .pulsating-dot { width: 10px; height: 10px; background: #ff3b3b; border-radius: 50%; box-shadow: 0 0 10px #ff3b3b; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="margin-top:0; font-size:16px;">ТЕРМИНАЛ</h3>
    <button class="btn" onclick="toggleSat()">Спутник / Карта</button>
    <button class="btn" onclick="loadJSON()">Обновить JSON</button>
    <hr style="border:0; border-top:1px solid #333; margin: 15px 0;">
    <button class="btn" id="drawBtn" onclick="toggleDraw()">Рисование: ВЫКЛ</button>
    <button class="btn red" onclick="clearCanvas()">Очистить рисунки</button>
    <input type="color" id="colorPicker" value="#c2b280" style="width:100%; height:30px; border:none; background:none; cursor:pointer;">
</div>

<div id="map-container">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. НАСТРОЙКА КАРТЫ
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.3, 37.5], 7);
    
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    let isSat = false;
    function toggleSat() {
        if (isSat) { map.removeLayer(satLayer); darkLayer.addTo(map); } 
        else { map.removeLayer(darkLayer); satLayer.addTo(map); }
        isSat = !isSat;
    }

    // 2. ЗАГРУЗКА ПОЛИГОНОВ
    let geoJsonLayer;
    const dotIcon = L.divIcon({ className: 'dot-container', html: '<div class="pulsating-dot"></div>' });

    async function loadJSON() {
        try {
            // Загружаем файл с анти-кэшем
            const response = await fetch('data/map.json?v=' + Date.now());
            if (!response.ok) throw new Error("Нет доступа к map.json");
            const data = await response.json();

            if (geoJsonLayer) map.removeLayer(geoJsonLayer);

            geoJsonLayer = L.geoJSON(data, {
                style: (f) => ({
                    fillColor: f.properties.color || "#8b0000",
                    color: f.properties.color || "#8b0000",
                    weight: 2,
                    fillOpacity: 0.4
                }),
                pointToLayer: (f, latlng) => L.marker(latlng, { icon: dotIcon }),
                onEachFeature: (f, layer) => {
                    if (f.properties && f.properties.name) {
                        layer.on('click', () => {
                            const activeTooltip = layer.getTooltip();
                            if (activeTooltip) layer.unbindTooltip();
                            else layer.bindTooltip(f.properties.name, { permanent: true }).openTooltip();
                        });
                    }
                }
            }).addTo(map);

            // Если есть полигоны, камера летит к ним
            const bounds = geoJsonLayer.getBounds();
            if (bounds.isValid()) map.fitBounds(bounds);

        } catch (err) {
            console.error(err);
        }
    }

    // 3. РИСОВАЛКА (С ПОДДЕРЖКОЙ ТЕЛЕФОНА)
    const canvas = document.getElementById('paint-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false, paintMode = false;

    function resize() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function toggleDraw() {
        paintMode = !paintMode;
        canvas.classList.toggle('active', paintMode);
        const btn = document.getElementById('drawBtn');
        btn.innerText = paintMode ? "Рисование: ВКЛ" : "Рисование: ВЫКЛ";
        btn.classList.toggle('active', paintMode);
        paintMode ? map.dragging.disable() : map.dragging.enable();
    }

    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function start(e) {
        if (!paintMode) return;
        drawing = true;
        const p = getCoords(e);
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.strokeStyle = document.getElementById('colorPicker').value;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
    }

    function move(e) {
        if (!drawing || !paintMode) return;
        if (e.cancelable) e.preventDefault();
        const p = getCoords(e);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
    }

    canvas.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => drawing = false);

    canvas.addEventListener('touchstart', (e) => { if(paintMode) start(e); }, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', () => drawing = false);

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    // Запуск загрузки
    loadJSON();
</script>

</body>
</html>
